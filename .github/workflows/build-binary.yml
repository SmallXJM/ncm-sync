name: Build Binaries

on:
  workflow_call:

jobs:
  # ---------------------------------------------------------
  # 步骤 1: 编译前端
  # ---------------------------------------------------------
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install & Build Frontend
        working-directory: web
        run: |
          bun install --frozen-lockfile
          bun run build

      # 将前端产物（web/dist）上传，供后续后端打包使用
      - name: Upload Frontend Assets
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 1

  # ---------------------------------------------------------
  # 步骤 2: 跨平台打包后端 (Windows & Linux) (使用 uv 极速安装)
  # ---------------------------------------------------------
  build-backend:
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})
    needs: build-frontend
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: Linux
            arch: x86_64
            archive_ext: tar.gz
            binary_name: ncm-sync
          - os: ubuntu-22.04-arm
            platform: Linux
            arch: aarch64
            archive_ext: tar.gz
            binary_name: ncm-sync
          - os: windows-latest
            platform: Windows
            arch: x86_64
            archive_ext: zip
            binary_name: ncm-sync.exe
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Assets
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/ # 对应 spec 文件中引用的前端路径

      # 使用 uv 代替 setup-python 的 pip 缓存
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      - name: Set up Python
        run: uv python install 3.9

      - name: Install Dependencies
        # 使用 --system 或者 uv venv 均可，打包环境推荐直接使用 uv pip
        run: |
          uv pip install pyinstaller
          if [ -f requirements.txt ]; then
            uv pip install -r requirements.txt
          fi
        shell: bash # 统一 shell 减少跨平台差异

      # ---------------------------------------------------------
      # 执行打包
      # ---------------------------------------------------------
      - name: PyInstaller Build
        # 使用 uv run 确保环境隔离
        run: uv run python -m PyInstaller ncm-sync.spec

      # ---------------------------------------------------------
      # 跨平台通用打包逻辑
      # ---------------------------------------------------------
      - name: Package Binary (Linux)
        if: runner.os == 'Linux'
        run: |
          tar -czf ncm-sync-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.archive_ext }} -C dist ${{ matrix.binary_name }}

      - name: Package Binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\${{ matrix.binary_name }} -DestinationPath ncm-sync-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.archive_ext }}

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ncm-sync-${{ matrix.platform }}-${{ matrix.arch }}
          path: ncm-sync-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.archive_ext }}
          retention-days: 7